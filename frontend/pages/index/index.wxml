<view class="container">
  
  <scroll-view 
    scroll-y 
    class="chat-history" 
    scroll-with-animation
    scroll-into-view="{{scrollIntoView}}"
    enhanced="{{true}}"
    show-scrollbar="{{false}}"
    bounces="{{false}}"
    bindscroll="onScroll"
    bindtouchstart="onTouchStart"
    bindtouchend="onTouchEnd"
  >
    <block wx:for="{{messages}}" wx:key="timestamp">
      <!-- 日期和时间显示 -->
      <view wx:if="{{item.formattedDate}}" class="date-label">{{item.formattedDate}}</view>
      
      <!-- 用户消息 -->
      <view class="message-item" id="msg-{{index}}" wx:if="{{item.role === 'user'}}">
        <view class="user-message">
          <text user-select="true">{{item.content}}</text>
        </view>
      </view>

      <!-- AI 消息 -->
      <view class="message-item" id="msg-{{index}}" wx:if="{{item.role === 'assistant'}}">
        <view class="ai-message {{item.isLoading ? 'loading-message' : ''}}">
          <!-- 加载动画 -->
          <view wx:if="{{item.isLoading}}" class="loading-container">
            <text class="loading-text">正在生成</text>
            <text class="loading-dots"></text>
          </view>
          <!-- 【关键简化】直接渲染 content，不再需要 segments 和 if/else 判断 -->
          <text wx:else user-select="true">{{item.content}}</text>
        </view>
        
        <!-- 建议问题区域 -->
        <view class="suggestions-container" 
              wx:if="{{item.suggestions && item.suggestions.length > 0}}">
          <view class="suggestions-grid">
            <view wx:for="{{item.suggestions}}" 
                  wx:for-item="suggestion" 
                  wx:key="*this"
                  class="suggestion-chip"
                  data-question="{{suggestion}}"
                  data-msg-index="{{index}}"
                  bind:tap="onSuggestionTap">
              <text class="suggestion-text">{{suggestion}}</text>
            </view>
          </view>
        </view>
      </view>
    </block>
    
    <!-- 【关键新增】在所有消息循环的下方，添加一个永久的底部锚点 -->
    <view id="chat-bottom-anchor"></view>
    
  </scroll-view>

  <!-- 输入区域 -->
  <view class="input-area">
    <view class="input-container">
      <view class="input-wrapper">
        <input
          class="input-box"
          placeholder=""
          bindinput="bindInput"
          bindconfirm="sendMessage"
          bindfocus="handleFocus"
          value="{{userInput}}"
          maxlength="500"
          cursor-spacing="20"
          confirm-type="send"
          adjust-position="{{true}}"
        />
        <!-- 自定义 placeholder，当没有输入内容时显示 -->
        <view wx:if="{{!userInput}}" class="custom-placeholder">请输入您的问题</view>
      </view>
      <!-- <image 
        wx:if="{{!userInput}}"
        class="mode-switch-btn"
        src="/images/voice.png"
        bindtap="switchToVoice"
      /> -->
      <image 
        wx:if="{{userInput}}"
        class="send-btn"
        src="/images/send.png"
        bindtap="sendMessage"
      />
    </view>
  </view>

  <!-- 当用户滚动时显示的"回到底部"按钮 -->
  <view class="scroll-to-bottom" bindtap="forceScrollToBottom" wx:if="{{showScrollToBottom}}">
    <image src="/images/arrow-down.png" class="arrow-down-icon"></image>
  </view>
</view>
