<view class="container">
  
  <scroll-view 
    scroll-y 
    class="chat-history" 
    scroll-with-animation
    scroll-into-view="{{scrollIntoView}}"
    enhanced="{{true}}"
    show-scrollbar="{{false}}"
    bounces="{{false}}"
    bindscroll="onScroll"
    bindtouchstart="onTouchStart"
    bindtouchend="onTouchEnd"
  >
    <block wx:for="{{messages}}" wx:key="timestamp">
      <!-- æ—¥æœŸå’Œæ—¶é—´æ˜¾ç¤º -->
      <view wx:if="{{item.formattedDate}}" class="date-label">{{item.formattedDate}}</view>
      
      <!-- ç”¨æˆ·æ¶ˆæ¯ -->
      <view class="message-item" id="msg-{{index}}" wx:if="{{item.role === 'user'}}">
        <view class="user-message">
          <text user-select="true">{{item.content}}</text>
        </view>
      </view>

      <!-- AI æ¶ˆæ¯ -->
      <view class="message-item" id="msg-{{index}}" wx:if="{{item.role === 'assistant'}}">
        <view class="ai-message {{item.isLoading ? 'loading-message' : ''}}" 
              bindtap="onAIMessageTap" data-message-id="{{item.id}}">
          <!-- åŠ è½½åŠ¨ç”» -->
          <view wx:if="{{item.isLoading}}" class="loading-container">
            <text class="loading-text">æ­£åœ¨ç”Ÿæˆ</text>
            <text class="loading-dots"></text>
          </view>
          <!-- ã€å…³é”®ç®€åŒ–ã€‘ç›´æ¥æ¸²æŸ“ contentï¼Œä¸å†éœ€è¦ segments å’Œ if/else åˆ¤æ–­ -->
          <text wx:else user-select="true">{{item.content}}</text>
        </view>
        
        <!-- TTSæ§åˆ¶æŒ‰é’®ç»„ - ä»…åœ¨æ¶ˆæ¯å®Œæˆæ—¶æ˜¾ç¤º -->
        <view class="message-controls" wx:if="{{!item.isLoading && item.content}}">
          <!-- å¤åˆ¶æŒ‰é’® -->
          <view class="control-btn copy-btn" bindtap="copyMessage" data-content="{{item.content}}">
            <text class="control-icon">ğŸ“‹</text>
          </view>
          
          <!-- æœ—è¯»æ§åˆ¶æŒ‰é’® -->
          <view class="control-btn tts-btn" bindtap="toggleTTS" data-message-id="{{item.id}}">
            <!-- æœ—è¯»ä¸­ï¼šæ˜¾ç¤ºåŠ¨æ€å£°æ³¢ -->
            <view wx:if="{{item.isPlaying}}" class="sound-wave">
              <view class="wave-bar bar1"></view>
              <view class="wave-bar bar2"></view>
              <view class="wave-bar bar3"></view>
              <view class="wave-bar bar4"></view>
            </view>
            <!-- æœªæ’­æ”¾ï¼šæ˜¾ç¤ºå–‡å­å›¾æ ‡ -->
            <text wx:else class="control-icon">ğŸ”Š</text>
          </view>
        </view>
        
        <!-- å»ºè®®é—®é¢˜åŒºåŸŸ -->
        <view class="suggestions-container" 
              wx:if="{{item.suggestions && item.suggestions.length > 0}}">
          <view class="suggestions-grid">
            <view wx:for="{{item.suggestions}}" 
                  wx:for-item="suggestion" 
                  wx:key="*this"
                  class="suggestion-chip"
                  data-question="{{suggestion}}"
                  data-msg-index="{{index}}"
                  bind:tap="onSuggestionTap">
              <text class="suggestion-text">{{suggestion}}</text>
            </view>
          </view>
        </view>
      </view>
    </block>
    
    <!-- ã€å…³é”®æ–°å¢ã€‘åœ¨æ‰€æœ‰æ¶ˆæ¯å¾ªç¯çš„ä¸‹æ–¹ï¼Œæ·»åŠ ä¸€ä¸ªæ°¸ä¹…çš„åº•éƒ¨é”šç‚¹ -->
    <view id="chat-bottom-anchor"></view>
    
  </scroll-view>

  <!-- æµå¼è¯­éŸ³è¯†åˆ«ç•Œé¢å·²ç§»é™¤ -->

  <!-- è¾“å…¥åŒºåŸŸ -->
  <!-- æ–‡å­—è¾“å…¥æ¨¡å¼ -->
  <view class="input-area {{showVoiceModal ? 'hidden' : ''}}" wx:if="{{!isVoiceMode}}">
    <view class="input-container">
      <view class="input-wrapper"
            bindtouchstart="onInputTouchStart"
            bindtouchmove="onInputTouchMove"
            bindtouchend="onInputTouchEnd"
            bindtouchcancel="onInputTouchCancel">
        <input
          class="input-box"
          placeholder=""
          bindinput="bindInput"
          bindconfirm="sendMessage"
          bindfocus="handleFocus"
          value="{{userInput}}"
          maxlength="500"
          cursor-spacing="20"
          confirm-type="send"
          adjust-position="{{true}}"
        />
        <!-- è‡ªå®šä¹‰ placeholderï¼Œå½“æ²¡æœ‰è¾“å…¥å†…å®¹æ—¶æ˜¾ç¤º -->
        <view wx:if="{{!userInput}}" class="custom-placeholder {{isInputRecording ? 'recording' : ''}}">
          {{isInputRecording ? recordingText : (keyboardHeight > 0 ? 'å‘æ¶ˆæ¯' : 'å‘æ¶ˆæ¯æˆ–æŒ‰ä½è¯´è¯')}}
        </view>
      </view>
      <image 
        wx:if="{{!userInput}}"
        class="mode-switch-btn"
        src="/images/voice.png"
        bindtap="switchToVoice"
      />
      <image 
        wx:if="{{userInput}}"
        class="send-btn"
        src="/images/send.svg"
        bindtap="sendMessage"
      />
    </view>
  </view>

  <!-- è¯­éŸ³è¾“å…¥æ¨¡å¼ -->
  <view class="voice-input-area {{showVoiceModal ? 'hidden' : ''}}" wx:if="{{isVoiceMode}}">
    <view class="voice-container">
      <!-- å ä½å…ƒç´ ä¿æŒå¸ƒå±€å¹³è¡¡ -->
      <view style="width: 56rpx; height: 56rpx;"></view>
      
      <!-- æŒ‰ä½è¯´è¯æŒ‰é’® -->
      <button class="voice-btn {{isRecording ? 'recording' : ''}}"
              bindtouchstart="onVoiceTouchStart"
              bindtouchmove="onVoiceTouchMove" 
              bindtouchend="onVoiceTouchEnd"
              bindtouchcancel="onVoiceTouchCancel">
        <text class="voice-text">{{recordingText}}</text>
      </button>
      
      <!-- é”®ç›˜æŒ‰é’®ï¼ˆå³ä¾§ï¼‰ -->
      <image class="mode-switch-btn"
             src="/images/keyboard-circle.svg"
             bindtap="switchToText" />
    </view>
  </view>

  <!-- å½“ç”¨æˆ·æ»šåŠ¨æ—¶æ˜¾ç¤ºçš„"å›åˆ°åº•éƒ¨"æŒ‰é’® -->
  <view class="scroll-to-bottom" bindtap="forceScrollToBottom" wx:if="{{showScrollToBottom}}">
    <image src="/images/arrow-down.png" class="arrow-down-icon"></image>
  </view>

  <!-- åº•éƒ¨å½•éŸ³ç•Œé¢ -->
  <view class="voice-recording-overlay" wx:if="{{showVoiceModal}}">
    <view class="voice-recording-container {{isRecordingCanceling ? 'canceling' : ''}}">
      <!-- å½•éŸ³æç¤ºä¿¡æ¯ - åœ¨æ³¢å½¢ä¸Šæ–¹ -->
      <view class="recording-tips">
        <text class="recording-duration">{{recordingDuration}}s</text>
        <text class="recording-hint" wx:if="{{!isRecordingCanceling}}">æ¾æ‰‹å‘é€ï¼Œä¸Šç§»å–æ¶ˆ</text>
        <text class="canceling-hint" wx:if="{{isRecordingCanceling}}">æ¾æ‰‹å–æ¶ˆå‘é€</text>
      </view>
      
      <!-- æ³¢å½¢å¯è§†åŒ– -->
      <view class="waveform-container">
        <view class="waveform-bars">
          <view wx:for="{{waveformData}}" 
                wx:key="index"
                class="waveform-bar"
                style="height: {{item}}%"></view>
        </view>
      </view>
    </view>
  </view>
</view>
