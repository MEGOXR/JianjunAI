<view class="container">
  
  <scroll-view 
    scroll-y 
    class="chat-history" 
    scroll-with-animation
    scroll-into-view="{{scrollIntoView}}"
    enhanced="{{true}}"
    show-scrollbar="{{false}}"
    bounces="{{false}}"
    bindscroll="onScroll"
    bindtouchstart="onTouchStart"
    bindtouchend="onTouchEnd"
  >
    <block wx:for="{{messages}}" wx:key="timestamp">
      <!-- 日期和时间显示 -->
      <view wx:if="{{item.formattedDate}}" class="date-label">{{item.formattedDate}}</view>
      
      <!-- 用户消息 -->
      <view class="message-item" id="msg-{{index}}" wx:if="{{item.role === 'user'}}">
        <view class="user-message">
          <!-- 图片显示 -->
          <view wx:if="{{item.images && item.images.length > 0}}" class="message-images">
            <view wx:for="{{item.images}}" wx:key="*this" wx:for-item="imgUrl" class="message-image-wrapper">
              <image
                src="{{imgUrl}}"
                mode="aspectFill"
                class="message-image"
                bindtap="previewMessageImage"
                data-current="{{imgUrl}}"
                data-urls="{{item.images}}"
              />
            </view>
          </view>
          <!-- 文字内容 -->
          <text wx:if="{{item.content}}" user-select="true">{{item.content}}</text>
        </view>
      </view>

      <!-- AI 消息 -->
      <view class="message-item" id="msg-{{index}}" wx:if="{{item.role === 'assistant'}}">
        <view class="ai-message {{item.isLoading ? 'loading-message' : ''}}">
          <!-- 加载动画 -->
          <view wx:if="{{item.isLoading}}" class="loading-container">
            <view class="pulse-dot"></view>
            <text class="loading-text">{{item.loadingText || '正在生成...'}}</text>
          </view>
          <!-- 消息内容和复制按钮 -->
          <view wx:else class="message-content-wrapper">
            <!-- Markdown 渲染 -->
            <block wx:for="{{item.parsedContent}}" wx:key="index" wx:for-item="block">
              <!-- 标题 -->
              <view wx:if="{{block.type === 'header'}}" class="md-header h{{block.level}}">
                <block wx:for="{{block.content}}" wx:key="i" wx:for-item="span">
                  <text class="{{span.type === 'bold' ? 'md-bold' : ''}}" user-select="true">{{span.text}}</text>
                </block>
              </view>

              <!-- 段落 -->
              <view wx:if="{{block.type === 'paragraph'}}" class="md-p">
                <text user-select="true"><block wx:for="{{block.content}}" wx:key="i" wx:for-item="span"><text class="{{span.type === 'bold' ? 'md-bold' : ''}}">{{span.text}}</text></block></text>
              </view>

              <!-- 列表 -->
              <view wx:if="{{block.type === 'list'}}" class="md-list">
                <view wx:for="{{block.items}}" wx:key="i" wx:for-item="li" class="md-list-item" style="margin-left: {{li.level * 1}}em;">
                  <!-- 根据层级显示不同的列表标记 -->
                  <view class="md-list-marker">
                    <block wx:if="{{li.type === 'ordered'}}">{{li.level === 0 ? (index + 1) + '.' : (li.level === 1 ? (index + 1) + '.' : (index + 1) + '.')}}</block>
                    <block wx:else>{{li.level === 0 ? '•' : (li.level === 1 ? '◦' : '▪')}}</block>
                  </view>
                  <view class="md-list-content">
                    <text user-select="true"><block wx:for="{{li.content}}" wx:key="j" wx:for-item="span"><text class="{{span.type === 'bold' ? 'md-bold' : ''}}">{{span.text}}</text></block></text>
                  </view>
                </view>
              </view>

              <!-- 表格 -->
              <view wx:if="{{block.type === 'table'}}" class="md-table-wrapper">
                <scroll-view scroll-x="true" class="md-table-scroll-view">
                  <view class="md-table">
                    <!-- 表头 -->
                    <view class="md-table-row header">
                      <view wx:for="{{block.header}}" wx:key="i" wx:for-item="cell" class="md-table-cell">
                        <text user-select="true"><block wx:for="{{cell}}" wx:key="j" wx:for-item="span"><text class="{{span.type === 'bold' ? 'md-bold' : ''}}">{{span.text}}</text></block></text>
                      </view>
                    </view>
                    <!-- 表体 -->
                    <view wx:for="{{block.rows}}" wx:key="i" wx:for-item="row" class="md-table-row">
                      <view wx:for="{{row}}" wx:key="j" wx:for-item="cell" class="md-table-cell">
                        <text user-select="true"><block wx:for="{{cell}}" wx:key="k" wx:for-item="span"><text class="{{span.type === 'bold' ? 'md-bold' : ''}}">{{span.text}}</text></block></text>
                      </view>
                    </view>
                  </view>
                </scroll-view>
              </view>
            </block>

            <!-- 复制按钮 - 另起一行放在右下角 -->
            <view style="clear: both; text-align: right; margin-top: 8rpx;">
              <view class="inline-copy-btn" bindtap="copyMessage" data-content="{{item.content}}" wx:if="{{item.content}}">
                <image class="copy-icon" src="/images/copy.svg" />
              </view>
            </view>
          </view>
        </view>
        
        <!-- 建议问题区域 -->
        <view class="suggestions-container" 
              wx:if="{{item.suggestions && item.suggestions.length > 0}}">
          <view class="suggestions-grid">
            <view wx:for="{{item.suggestions}}" 
                  wx:for-item="suggestion" 
                  wx:key="*this"
                  class="suggestion-chip"
                  data-question="{{suggestion}}"
                  data-msg-index="{{index}}"
                  bind:tap="onSuggestionTap">
              <text class="suggestion-text">{{suggestion}}</text>
            </view>
          </view>
        </view>
      </view>
    </block>
    
    <!-- 【关键新增】在所有消息循环的下方，添加一个永久的底部锚点 -->
    <view id="chat-bottom-anchor"></view>
    
  </scroll-view>

  <!-- 流式语音识别界面已移除 -->

  <!-- 输入区域 -->
  <!-- AI 免责声明 -->
  <view class="disclaimer-text">内容由AI生成，仅供参考</view>
  
  <!-- 图片预览区域 - 豆包风格 -->
  <view class="image-preview-container-new" wx:if="{{selectedImages.length > 0 || uploadingImages.length > 0}}">
    <view class="image-grid">
      <!-- 上传中的图片 -->
      <view wx:for="{{uploadingImages}}" wx:key="index" class="image-grid-item uploading">
        <image src="{{item.path}}" mode="aspectFill" class="grid-image"/>
        <view class="upload-loading">
          <view class="loading-ring"></view>
        </view>
      </view>

      <!-- 已上传的图片 -->
      <view wx:for="{{selectedImages}}" wx:key="index" class="image-grid-item">
        <image src="{{item}}" mode="aspectFill" class="grid-image"/>
        <view class="remove-image-btn-new" bindtap="removeImage" data-index="{{index}}">
          <text class="remove-icon-new">×</text>
        </view>
      </view>

      <!-- 添加更多按钮 -->
      <view wx:if="{{selectedImages.length < 3}}" class="image-grid-item add-more" bindtap="showImageSourcePicker">
        <text class="add-icon">+</text>
      </view>
    </view>
  </view>

  <!-- 相机/相册选择弹窗 -->
  <view class="image-source-modal" wx:if="{{showImageSourceModal}}" bindtap="hideImageSourcePicker">
    <view class="image-source-content" catchtap="stopPropagation">
      <view class="source-option" bindtap="openCamera">
        <image class="source-icon" src="/images/camera-icon.svg"/>
        <text class="source-text">相机</text>
      </view>
      <view class="source-option" bindtap="openAlbum">
        <image class="source-icon" src="/images/album-icon.svg"/>
        <text class="source-text">相册</text>
      </view>
    </view>
  </view>

  <!-- 文字输入模式 - 豆包风格 -->
  <view class="input-area-new {{showVoiceModal ? 'hidden' : ''}}" wx:if="{{!isVoiceMode}}">
    <view class="input-container-new">
      <!-- 左侧相机按钮 -->
      <view class="camera-btn" bindtap="showImageSourcePicker">
        <image class="camera-icon" src="/images/camera-btn.svg"/>
      </view>

      <!-- 中间输入框 -->
      <view class="input-wrapper-new"
            bindtouchstart="onInputTouchStart"
            bindtouchmove="onInputTouchMove"
            bindtouchend="onInputTouchEnd"
            bindtouchcancel="onInputTouchCancel">
        <input
          class="input-box-new"
          placeholder="{{keyboardHeight > 0 ? '发消息' : '输入问题或直接发送...'}}"
          bindinput="bindInput"
          bindconfirm="sendMessage"
          bindfocus="handleFocus"
          value="{{userInput}}"
          maxlength="500"
          cursor-spacing="20"
          confirm-type="send"
          adjust-position="{{true}}"
        />
      </view>

      <!-- 右侧按钮组 -->
      <view class="right-buttons">
        <!-- 语音按钮 -->
        <view wx:if="{{!userInput && selectedImages.length === 0}}"
              class="voice-btn-new"
              bindtap="switchToVoice">
          <image class="voice-icon" src="/images/voice.png"/>
        </view>

        <!-- 发送按钮 -->
        <view wx:if="{{userInput || selectedImages.length > 0}}"
              class="send-btn-new"
              bindtap="sendMessage">
          <image class="send-icon" src="/images/send-arrow.svg"/>
        </view>
      </view>
    </view>
  </view>

  <!-- 语音输入模式 -->
  <view class="voice-input-area {{showVoiceModal ? 'hidden' : ''}}" wx:if="{{isVoiceMode}}">
    <view class="voice-container">
      <!-- 占位元素保持布局平衡 -->
      <view style="width: 56rpx; height: 56rpx;"></view>
      
      <!-- 按住说话按钮 -->
      <button class="voice-btn {{isRecording ? 'recording' : ''}}"
              bindtouchstart="onVoiceTouchStart"
              bindtouchmove="onVoiceTouchMove" 
              bindtouchend="onVoiceTouchEnd"
              bindtouchcancel="onVoiceTouchCancel">
        <text class="voice-text">{{recordingText}}</text>
      </button>
      
      <!-- 键盘按钮（右侧） -->
      <image class="mode-switch-btn"
             src="/images/keyboard-circle.svg"
             bindtap="switchToText" />
    </view>
  </view>

  <!-- 当用户滚动时显示的"回到底部"按钮 -->
  <view class="scroll-to-bottom" bindtap="forceScrollToBottom" wx:if="{{showScrollToBottom}}">
    <image src="/images/arrow-down.png" class="arrow-down-icon"></image>
  </view>

  <!-- 底部录音界面 -->
  <view class="voice-recording-overlay" wx:if="{{showVoiceModal}}">
    <view class="voice-recording-container {{isRecordingCanceling ? 'canceling' : ''}}" 
          style="--volume-scale: {{1 + currentVolume * 0.003}}; --volume-glow: {{currentVolume}}">
      <!-- 录音提示信息 - 在波形上方 -->
      <view class="recording-tips">
        <text class="recording-duration">{{recordingDuration}}s</text>
        <text class="recording-hint" wx:if="{{!isRecordingCanceling}}">松手发送，上移取消</text>
        <text class="canceling-hint" wx:if="{{isRecordingCanceling}}">松手取消发送</text>
      </view>
      
      <!-- 波形可视化 -->
      <view class="waveform-container">
        <view class="waveform-bars">
          <view wx:for="{{waveformData}}" 
                wx:key="index"
                class="waveform-bar"
                style="height: {{item}}%"></view>
        </view>
      </view>
    </view>
  </view>
</view>