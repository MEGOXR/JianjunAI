<view class="container">
  <!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ -->
  <view class="user-info-bar" wx:if="{{!wxNickname}}">
    <text class="user-info-text">ğŸ‘‹ ä¸ºäº†æ›´å¥½çš„ä½“éªŒï¼Œå»ºè®®æˆæƒå¾®ä¿¡æ˜µç§°</text>
    <button class="auth-btn" bindtap="getUserInfo" size="mini" type="primary">æˆæƒ</button>
  </view>
  
  <scroll-view 
    scroll-y 
    class="chat-history" 
    scroll-with-animation
    scroll-into-view="{{scrollIntoView}}"
    enhanced="{{true}}"
    show-scrollbar="{{false}}"
    bounces="{{false}}"
    bindscroll="onScroll"
  >
    <block wx:for="{{messages}}" wx:key="timestamp">
      <!-- æ—¥æœŸå’Œæ—¶é—´æ˜¾ç¤º -->
      <view wx:if="{{item.formattedDate}}" class="date-label">{{item.formattedDate}}</view>
      
      <!-- ç”¨æˆ·æ¶ˆæ¯ -->
      <view class="message-item" id="msg-{{index}}" wx:if="{{item.role === 'user'}}">
        <view class="user-message">
          <text user-select="true">{{item.content}}</text>
        </view>
      </view>

      <!-- AI æ¶ˆæ¯ -->
      <view class="message-item" id="msg-{{index}}" wx:if="{{item.role === 'assistant'}}">
        <view class="ai-message">
          <!-- ã€å…³é”®ç®€åŒ–ã€‘ç›´æ¥æ¸²æŸ“ contentï¼Œä¸å†éœ€è¦ segments å’Œ if/else åˆ¤æ–­ -->
          <text user-select="true">{{item.content}}</text>
        </view>
      </view>
    </block>
    
    <!-- ã€å…³é”®æ–°å¢ã€‘åœ¨æ‰€æœ‰æ¶ˆæ¯å¾ªç¯çš„ä¸‹æ–¹ï¼Œæ·»åŠ ä¸€ä¸ªæ°¸ä¹…çš„åº•éƒ¨é”šç‚¹ -->
    <view id="chat-bottom-anchor"></view>
    
  </scroll-view>

  <!-- è¾“å…¥åŒºåŸŸ -->
  <view class="input-area">
    <view class="input-container">
      <view class="input-wrapper">
        <input
          class="input-box"
          placeholder=""
          bindinput="bindInput"
          bindconfirm="sendMessage"
          bindfocus="handleFocus"
          value="{{userInput}}"
          maxlength="500"
          cursor-spacing="20"
          confirm-type="send"
          adjust-position="{{true}}"
        />
        <!-- è‡ªå®šä¹‰ placeholderï¼Œå½“æ²¡æœ‰è¾“å…¥å†…å®¹æ—¶æ˜¾ç¤º -->
        <view wx:if="{{!userInput}}" class="custom-placeholder">è¯·è¾“å…¥æ‚¨çš„é—®é¢˜</view>
      </view>
      <!-- <image 
        wx:if="{{!userInput}}"
        class="mode-switch-btn"
        src="/images/voice.png"
        bindtap="switchToVoice"
      /> -->
      <image 
        wx:if="{{userInput}}"
        class="send-btn"
        src="/images/send.png"
        bindtap="sendMessage"
      />
    </view>
  </view>

  <!-- å½“ç”¨æˆ·æ»šåŠ¨æ—¶æ˜¾ç¤ºçš„"å›åˆ°åº•éƒ¨"æŒ‰é’® -->
  <view class="scroll-to-bottom" bindtap="forceScrollToBottom" wx:if="{{showScrollToBottom}}">
    <image src="/images/arrow-down.png" class="arrow-down-icon"></image>
  </view>
</view>
