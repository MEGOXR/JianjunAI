<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIPlasticSurgury - æœåŠ¡å™¨è¯Šæ–­</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .status-card {
            margin: 20px 0;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
            background: #f8f9fa;
        }
        .status-ok { border-left-color: #27ae60; }
        .status-error { border-left-color: #e74c3c; }
        .status-warning { border-left-color: #f39c12; }
        
        .config-section {
            margin: 15px 0;
        }
        .config-title {
            font-weight: bold;
            color: #34495e;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .config-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 8px 12px;
            background: #ecf0f1;
            border-radius: 4px;
        }
        .config-key {
            font-weight: 500;
            color: #2c3e50;
        }
        .config-value {
            color: #7f8c8d;
            font-family: monospace;
        }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #2980b9;
        }
        .loading {
            text-align: center;
            color: #7f8c8d;
        }
        .timestamp {
            text-align: center;
            color: #95a5a6;
            font-size: 0.9em;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ AIPlasticSurgury æœåŠ¡å™¨è¯Šæ–­</h1>
        
        <div class="status-card" id="overall-status">
            <div class="loading">æ­£åœ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...</div>
        </div>
        
        <div>
            <button class="btn" onclick="checkHealth()">æ£€æŸ¥å¥åº·çŠ¶æ€</button>
            <button class="btn" onclick="checkConfig()">æ£€æŸ¥é…ç½®</button>
            <button class="btn" onclick="testWebSocket()">æµ‹è¯•WebSocket</button>
            <button class="btn" onclick="refreshAll()">åˆ·æ–°å…¨éƒ¨</button>
        </div>
        
        <div id="results"></div>
        
        <div class="timestamp" id="last-updated"></div>
    </div>

    <script>
        let wsTest = null;
        
        async function checkHealth() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                displayHealthStatus(data);
            } catch (error) {
                displayError('å¥åº·æ£€æŸ¥å¤±è´¥: ' + error.message);
            }
        }
        
        async function checkConfig() {
            try {
                const response = await fetch('/config-check');
                const data = await response.json();
                displayConfig(data);
            } catch (error) {
                displayError('é…ç½®æ£€æŸ¥å¤±è´¥: ' + error.message);
            }
        }
        
        function testWebSocket() {
            const wsUrl = window.location.protocol === 'https:' 
                ? 'wss://' + window.location.host
                : 'ws://' + window.location.host;
                
            displayWebSocketTest('æ­£åœ¨æµ‹è¯•WebSocketè¿æ¥åˆ°: ' + wsUrl);
            
            if (wsTest) {
                wsTest.close();
            }
            
            wsTest = new WebSocket(wsUrl);
            
            wsTest.onopen = function() {
                displayWebSocketTest('âœ… WebSocketè¿æ¥æˆåŠŸ', 'ok');
                wsTest.send(JSON.stringify({
                    type: 'init',
                    wxNickname: 'è¯Šæ–­æµ‹è¯•'
                }));
            };
            
            wsTest.onmessage = function(event) {
                const data = JSON.parse(event.data);
                displayWebSocketTest('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ' + JSON.stringify(data, null, 2), 'ok');
            };
            
            wsTest.onerror = function(error) {
                displayWebSocketTest('âŒ WebSocketé”™è¯¯: ' + error.message, 'error');
            };
            
            wsTest.onclose = function(event) {
                displayWebSocketTest(`ğŸ”Œ WebSocketè¿æ¥å…³é—­ (ä»£ç : ${event.code})`, 'warning');
            };
        }
        
        function displayHealthStatus(data) {
            const statusDiv = document.getElementById('overall-status');
            statusDiv.className = 'status-card status-ok';
            statusDiv.innerHTML = `
                <div class="config-title">ğŸŸ¢ æœåŠ¡å™¨è¿è¡Œæ­£å¸¸</div>
                <div class="config-item">
                    <span class="config-key">çŠ¶æ€</span>
                    <span class="config-value">${data.status}</span>
                </div>
                <div class="config-item">
                    <span class="config-key">ç«¯å£</span>
                    <span class="config-value">${data.port}</span>
                </div>
                <div class="config-item">
                    <span class="config-key">æ—¶é—´æˆ³</span>
                    <span class="config-value">${data.timestamp}</span>
                </div>
            `;
        }
        
        function displayConfig(data) {
            const resultsDiv = document.getElementById('results');
            
            let azureStatus = 'status-ok';
            if (data.azure.endpoint === 'æœªè®¾ç½®' || data.azure.apiKey === 'æœªè®¾ç½®') {
                azureStatus = 'status-error';
            }
            
            resultsDiv.innerHTML = `
                <div class="status-card">
                    <div class="config-title">ğŸ–¥ï¸ æœåŠ¡å™¨é…ç½®</div>
                    <div class="config-item">
                        <span class="config-key">ç«¯å£</span>
                        <span class="config-value">${data.server.port} (ç¯å¢ƒå˜é‡: ${data.server.originalPortEnv || 'æœªè®¾ç½®'})</span>
                    </div>
                    <div class="config-item">
                        <span class="config-key">Node.jsç‰ˆæœ¬</span>
                        <span class="config-value">${data.server.nodeVersion}</span>
                    </div>
                    <div class="config-item">
                        <span class="config-key">å·¥ä½œç›®å½•</span>
                        <span class="config-value">${data.server.workingDirectory}</span>
                    </div>
                </div>
                
                <div class="status-card ${azureStatus}">
                    <div class="config-title">â˜ï¸ Azure OpenAI é…ç½®</div>
                    <div class="config-item">
                        <span class="config-key">ç»ˆç«¯åœ°å€</span>
                        <span class="config-value">${typeof data.azure.endpoint === 'object' ? data.azure.endpoint.value : data.azure.endpoint}</span>
                    </div>
                    <div class="config-item">
                        <span class="config-key">APIå¯†é’¥</span>
                        <span class="config-value">${typeof data.azure.apiKey === 'object' ? data.azure.apiKey.preview + ' (é•¿åº¦: ' + data.azure.apiKey.length + ')' : data.azure.apiKey}</span>
                    </div>
                    <div class="config-item">
                        <span class="config-key">APIç‰ˆæœ¬</span>
                        <span class="config-value">${data.azure.apiVersion}</span>
                    </div>
                    <div class="config-item">
                        <span class="config-key">éƒ¨ç½²åç§°</span>
                        <span class="config-value">${data.azure.deployment}</span>
                    </div>
                </div>
                
                <div class="status-card">
                    <div class="config-title">ğŸŒ ç¯å¢ƒä¿¡æ¯</div>
                    <div class="config-item">
                        <span class="config-key">è¿è¡Œç¯å¢ƒ</span>
                        <span class="config-value">${data.environment.nodeEnv}</span>
                    </div>
                    <div class="config-item">
                        <span class="config-key">ç½‘ç«™ä¸»æœºå</span>
                        <span class="config-value">${data.environment.websiteHostname}</span>
                    </div>
                    <div class="config-item">
                        <span class="config-key">ç½‘ç«™åç§°</span>
                        <span class="config-value">${data.environment.websiteSiteName}</span>
                    </div>
                </div>
            `;
        }
        
        function displayWebSocketTest(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const statusClass = type === 'ok' ? 'status-ok' : (type === 'error' ? 'status-error' : 'status-warning');
            
            resultsDiv.innerHTML = `
                <div class="status-card ${statusClass}">
                    <div class="config-title">ğŸ”Œ WebSocket æµ‹è¯•</div>
                    <pre style="white-space: pre-wrap; margin: 10px 0;">${message}</pre>
                </div>
            `;
        }
        
        function displayError(message) {
            document.getElementById('results').innerHTML = `
                <div class="status-card status-error">
                    <div class="config-title">âŒ é”™è¯¯</div>
                    <div>${message}</div>
                </div>
            `;
        }
        
        function refreshAll() {
            checkHealth();
            setTimeout(checkConfig, 500);
        }
        
        function updateTimestamp() {
            document.getElementById('last-updated').textContent = 
                'æœ€åæ›´æ–°: ' + new Date().toLocaleString('zh-CN');
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            refreshAll();
            updateTimestamp();
            setInterval(updateTimestamp, 1000);
        };
    </script>
</body>
</html>