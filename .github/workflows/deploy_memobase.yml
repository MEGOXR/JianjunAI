name: Deploy Memobase

on:
  push:
    paths:
      - 'deploy/memobase/**'
    branches:
      - main  # 只有推送到 main 分支时才触发
  workflow_dispatch: # 允许手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # 创建 .env 文件，包含敏感信息
      # Azure OpenAI v1 兼容端点格式: https://{resource}.cognitiveservices.azure.com/openai/v1/
      - name: Create .env file with secrets
        run: |
          ENDPOINT="${{ secrets.AZURE_OPENAI_ENDPOINT }}"
          # 移除末尾斜杠
          ENDPOINT="${ENDPOINT%/}"

          # 构建 v1 兼容端点 (在原始端点后追加 /openai/v1/)
          EMBEDDING_URL="${ENDPOINT}/openai/v1/"

          echo "Original endpoint: $ENDPOINT"
          echo "Embedding URL: $EMBEDDING_URL"

          cat > deploy/memobase/.env << EOF
          AZURE_OPENAI_API_KEY=${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_ENDPOINT=${ENDPOINT}
          AZURE_OPENAI_EMBEDDING_URL=${EMBEDDING_URL}
          EOF

      - name: Copy files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.AZURE_HOST_IP }}
          username: azureuser
          key: ${{ secrets.AZURE_SSH_KEY }}
          source: "deploy/memobase/docker-compose.yml,deploy/memobase/config.yaml,deploy/memobase/.env"
          target: "/home/azureuser/memobase"
          strip_components: 2

      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AZURE_HOST_IP }}
          username: azureuser
          key: ${{ secrets.AZURE_SSH_KEY }}
          script: |
            cd /home/azureuser/memobase
            # 使用官方 Memobase 镜像（公开镜像，无需登录）
            docker compose pull memobase
            docker compose up -d memobase
            docker system prune -f  # 清理旧镜像
