name: Deploy Memobase

on:
  push:
    paths:
      - 'deploy/memobase/**'
    branches:
      - main  # 只有推送到 main 分支时才触发
  workflow_dispatch: # 允许手动触发

env:
  REGISTRY: ghcr.io
  # 必须全小写，否则 Docker 会报错。手动指定确保安全。
  IMAGE_NAME: megoxr/jianjunai/memobase

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=sha

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: ./deploy/memobase
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    # 只有当配置了 Azure SSH Secret 时才运行部署步骤
    if: true
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # 创建 .env 文件，包含敏感信息
      # Azure OpenAI v1 兼容端点格式: https://{resource}.cognitiveservices.azure.com/openai/v1/
      - name: Create .env file with secrets
        run: |
          ENDPOINT="${{ secrets.AZURE_OPENAI_ENDPOINT }}"
          # 移除末尾斜杠
          ENDPOINT="${ENDPOINT%/}"

          # 构建 v1 兼容端点 (在原始端点后追加 /openai/v1/)
          EMBEDDING_URL="${ENDPOINT}/openai/v1/"

          echo "Original endpoint: $ENDPOINT"
          echo "Embedding URL: $EMBEDDING_URL"

          cat > deploy/memobase/.env << EOF
          AZURE_OPENAI_API_KEY=${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_ENDPOINT=${ENDPOINT}
          AZURE_OPENAI_EMBEDDING_URL=${EMBEDDING_URL}
          EOF

      - name: Copy files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.AZURE_HOST_IP }}
          username: azureuser
          key: ${{ secrets.AZURE_SSH_KEY }}
          source: "deploy/memobase/docker-compose.yml,deploy/memobase/config.yaml,deploy/memobase/.env"
          target: "/home/azureuser/memobase"
          strip_components: 2

      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AZURE_HOST_IP }}
          username: azureuser
          key: ${{ secrets.AZURE_SSH_KEY }}
          script: |
            cd /home/azureuser/memobase
            # 登录 GHCR 以拉取私有镜像 (如果仓库是私有的)
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # 拉取最新镜像并重启
            docker compose pull memobase
            docker compose up -d memobase
            docker system prune -f  # 清理旧镜像
