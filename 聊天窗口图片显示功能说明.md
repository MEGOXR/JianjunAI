# èŠå¤©çª—å£å›¾ç‰‡æ˜¾ç¤ºåŠŸèƒ½è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å·²æˆåŠŸå®ç°åœ¨èŠå¤©çª—å£ä¸­æ˜¾ç¤ºç”¨æˆ·å‘é€çš„å›¾ç‰‡ï¼Œå¹¶æ”¯æŒç‚¹å‡»é¢„è§ˆå¤§å›¾ï¼Œç±»ä¼¼è±†åŒ…çš„ä½“éªŒã€‚

## âœ… å®Œæˆçš„åŠŸèƒ½

### 1. æ¶ˆæ¯æ•°æ®ç»“æ„æ›´æ–°

**ä¿®æ”¹ä½ç½®**: `frontend/pages/index/modules/message-manager.js`

**ä¿®æ”¹å†…å®¹**:
- `createUserMessage` æ–¹æ³•æ–°å¢ `images` å‚æ•°
- æ¶ˆæ¯å¯¹è±¡æ–°å¢ `images` å­—æ®µï¼Œä¿å­˜å›¾ç‰‡è·¯å¾„æ•°ç»„
- `sendMessage` æ–¹æ³•ä¼ å…¥å›¾ç‰‡è·¯å¾„åˆ°æ¶ˆæ¯å¯¹è±¡

```javascript
createUserMessage(content, images = []) {
  const newUserMessage = {
    id: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
    role: 'user',
    content: content,
    timestamp: Date.now(),
    images: images  // ä¿å­˜å›¾ç‰‡è·¯å¾„
  };
  // ...
}
```

### 2. èŠå¤©ç•Œé¢å›¾ç‰‡æ˜¾ç¤º

**ä¿®æ”¹ä½ç½®**: `frontend/pages/index/index.wxml`

**æ˜¾ç¤ºç‰¹ç‚¹**:
- å›¾ç‰‡æ˜¾ç¤ºåœ¨æ–‡å­—å†…å®¹ä¸Šæ–¹
- æ”¯æŒåŒæ—¶æ˜¾ç¤ºå¤šå¼ å›¾ç‰‡
- å›¾ç‰‡å°ºå¯¸æ ¹æ®æ•°é‡è‡ªåŠ¨è°ƒæ•´ï¼š
  - **1å¼ å›¾ç‰‡**: 420rpx Ã— 420rpx (å¤§å›¾æ˜¾ç¤º)
  - **2å¼ å›¾ç‰‡**: 240rpx Ã— 240rpx (å¹¶æ’æ˜¾ç¤º)
  - **3å¼ å›¾ç‰‡**: 160rpx Ã— 160rpx (ç½‘æ ¼æ˜¾ç¤º)

**WXMLç»“æ„**:
```xml
<view class="user-message">
  <!-- å›¾ç‰‡æ˜¾ç¤º -->
  <view wx:if="{{item.images && item.images.length > 0}}" class="message-images">
    <view wx:for="{{item.images}}" wx:key="*this" wx:for-item="imgUrl" class="message-image-wrapper">
      <image
        src="{{imgUrl}}"
        mode="aspectFill"
        class="message-image"
        bindtap="previewMessageImage"
        data-current="{{imgUrl}}"
        data-urls="{{item.images}}"
      />
    </view>
  </view>
  <!-- æ–‡å­—å†…å®¹ -->
  <text wx:if="{{item.content}}" user-select="true">{{item.content}}</text>
</view>
```

### 3. å›¾ç‰‡æ ·å¼è®¾è®¡

**ä¿®æ”¹ä½ç½®**: `frontend/pages/index/index.wxss`

**è®¾è®¡ç»†èŠ‚**:
- **åœ†è§’**: 16rpxï¼ŒæŸ”å’Œç¾è§‚
- **é—´è·**: 12rpxï¼Œå›¾ç‰‡ä¹‹é—´ç•™ç™½é€‚ä¸­
- **å¸ƒå±€**: Flexbox è‡ªåŠ¨æ¢è¡Œ
- **èƒŒæ™¯**: åŠé€æ˜ç°è‰²ï¼Œå›¾ç‰‡åŠ è½½å‰æ˜¾ç¤º
- **æœ€å¤§å®½åº¦**: 500rpxï¼Œä¸è¶…å‡ºæ¶ˆæ¯æ°”æ³¡

**å“åº”å¼å¸ƒå±€**:
```css
/* å•å¼ å›¾ç‰‡ */
.message-image-wrapper:first-child:last-child {
  width: 420rpx;
  height: 420rpx;
}

/* ä¸¤å¼ å›¾ç‰‡ */
.message-image-wrapper:first-child:nth-last-child(2),
.message-image-wrapper:nth-child(2):last-child {
  width: 240rpx;
  height: 240rpx;
}

/* ä¸‰å¼ å›¾ç‰‡ */
.message-image-wrapper:first-child:nth-last-child(3),
.message-image-wrapper:nth-child(2):nth-last-child(2),
.message-image-wrapper:nth-child(3):last-child {
  width: 160rpx;
  height: 160rpx;
}
```

### 4. å›¾ç‰‡é¢„è§ˆåŠŸèƒ½

**ä¿®æ”¹ä½ç½®**: `frontend/pages/index/index.js`

**åŠŸèƒ½å®ç°**:
- ç‚¹å‡»å›¾ç‰‡è°ƒç”¨å¾®ä¿¡å°ç¨‹åºåŸç”Ÿé¢„è§ˆAPI
- æ”¯æŒå·¦å³æ»‘åŠ¨æŸ¥çœ‹æ‰€æœ‰å›¾ç‰‡
- æ”¯æŒç¼©æ”¾ã€ä¿å­˜ç­‰åŸç”Ÿæ“ä½œ

**å®ç°ä»£ç **:
```javascript
previewMessageImage: function(e) {
  const current = e.currentTarget.dataset.current;
  const urls = e.currentTarget.dataset.urls;

  wx.previewImage({
    current: current,  // å½“å‰æ˜¾ç¤ºå›¾ç‰‡çš„é“¾æ¥
    urls: urls         // éœ€è¦é¢„è§ˆçš„å›¾ç‰‡é“¾æ¥åˆ—è¡¨
  });
}
```

## ğŸ¨ è§†è§‰æ•ˆæœ

### å¸ƒå±€æ ·å¼
- **å•å¼ å›¾ç‰‡**: 420Ã—420rpx æ­£æ–¹å½¢ï¼Œçªå‡ºæ˜¾ç¤º
- **ä¸¤å¼ å›¾ç‰‡**: 240Ã—240rpxï¼Œæ¨ªå‘å¹¶æ’
- **ä¸‰å¼ å›¾ç‰‡**: 160Ã—160rpxï¼Œç½‘æ ¼æ’åˆ—

### äº¤äº’åé¦ˆ
- **ç‚¹å‡»æ•ˆæœ**: é€æ˜åº¦é™ä½ + è½»å¾®ç¼©æ”¾ (scale 0.98)
- **åœ†è§’è®¾è®¡**: 16rpxï¼Œä¸æ•´ä½“UIé£æ ¼ä¸€è‡´
- **é—´è·æ§åˆ¶**: 12rpxï¼Œè§†è§‰èˆ’é€‚

### ä¸è±†åŒ…å¯¹æ¯”
âœ… å›¾ç‰‡åœ¨æ¶ˆæ¯æ°”æ³¡å†…æ˜¾ç¤º
âœ… åœ†è§’è®¾è®¡
âœ… æ ¹æ®æ•°é‡è°ƒæ•´å°ºå¯¸
âœ… ç‚¹å‡»é¢„è§ˆå¤§å›¾
âœ… æµç•…çš„äº¤äº’åŠ¨ç”»

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### 1. `frontend/pages/index/modules/message-manager.js`
**ä¿®æ”¹å†…å®¹**:
- ä¿®æ”¹ `createUserMessage()` æ–¹æ³•ï¼Œæ·»åŠ  `images` å‚æ•°
- ä¿®æ”¹ `sendMessage()` æ–¹æ³•ï¼Œä¼ å…¥å›¾ç‰‡è·¯å¾„
- å‘é€åæ¸…ç©º `uploadingImages` çŠ¶æ€

**å…³é”®å˜æ›´**:
```javascript
// åˆ›å»ºç”¨æˆ·æ¶ˆæ¯ï¼Œä¼ å…¥å›¾ç‰‡è·¯å¾„
const newUserMessage = this.createUserMessage(userMessageContent, selectedImages);

// æ¸…ç©ºå›¾ç‰‡åˆ—è¡¨
this.page.setData({
  selectedImages: [],
  uploadingImages: []
});
```

### 2. `frontend/pages/index/index.wxml`
**ä¿®æ”¹å†…å®¹**:
- åœ¨ç”¨æˆ·æ¶ˆæ¯ä¸­æ·»åŠ å›¾ç‰‡æ˜¾ç¤ºåŒºåŸŸ
- ä½¿ç”¨ `wx:for` éå†å›¾ç‰‡æ•°ç»„
- ç»‘å®š `previewMessageImage` ç‚¹å‡»äº‹ä»¶

### 3. `frontend/pages/index/index.wxss`
**æ–°å¢å†…å®¹**:
- `.message-images` - å›¾ç‰‡å®¹å™¨æ ·å¼
- `.message-image-wrapper` - å›¾ç‰‡åŒ…è£…å™¨
- `.message-image` - å›¾ç‰‡æ ·å¼
- å“åº”å¼å°ºå¯¸è§„åˆ™ï¼ˆ1/2/3å¼ ä¸åŒå°ºå¯¸ï¼‰

### 4. `frontend/pages/index/index.js`
**æ–°å¢å†…å®¹**:
- `previewMessageImage()` æ–¹æ³• - å›¾ç‰‡é¢„è§ˆåŠŸèƒ½

## ğŸ”„ å®Œæ•´æµç¨‹

### å‘é€å¸¦å›¾ç‰‡çš„æ¶ˆæ¯æµç¨‹:

1. **ç”¨æˆ·é€‰æ‹©å›¾ç‰‡** â†’ æ˜¾ç¤ºåœ¨é¢„è§ˆåŒºåŸŸ
2. **ç‚¹å‡»å‘é€** â†’ è§¦å‘ `sendMessage()`
3. **åˆ›å»ºæ¶ˆæ¯å¯¹è±¡** â†’ åŒ…å« `content` å’Œ `images`
4. **æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨** â†’ æ¸²æŸ“åˆ°èŠå¤©çª—å£
5. **å›¾ç‰‡æ˜¾ç¤º** â†’ æ ¹æ®æ•°é‡è‡ªåŠ¨è°ƒæ•´å°ºå¯¸
6. **è½¬æ¢ base64** â†’ å‘é€åˆ°åç«¯ Vision API
7. **æ¸…ç©ºé¢„è§ˆ** â†’ é‡ç½®è¾“å…¥çŠ¶æ€

### æŸ¥çœ‹å›¾ç‰‡æµç¨‹:

1. **ç‚¹å‡»æ¶ˆæ¯ä¸­çš„å›¾ç‰‡** â†’ è§¦å‘ `previewMessageImage()`
2. **è°ƒç”¨å¾®ä¿¡ API** â†’ `wx.previewImage()`
3. **æ˜¾ç¤ºé¢„è§ˆç•Œé¢** â†’ å…¨å±æŸ¥çœ‹ã€ç¼©æ”¾
4. **å·¦å³æ»‘åŠ¨** â†’ æŸ¥çœ‹åŒæ¶ˆæ¯ä¸­çš„å…¶ä»–å›¾ç‰‡
5. **é•¿æŒ‰æ“ä½œ** â†’ ä¿å­˜å›¾ç‰‡ã€åˆ†äº«ç­‰

## ğŸ“Š æŠ€æœ¯ç»†èŠ‚

### æ•°æ®æµè½¬
```
ç”¨æˆ·é€‰æ‹©å›¾ç‰‡
    â†“
å­˜å‚¨åœ¨ selectedImages (ä¸´æ—¶è·¯å¾„)
    â†“
åˆ›å»ºæ¶ˆæ¯æ—¶ä¿å­˜åˆ° message.images
    â†“
WXML éå† images æ•°ç»„æ˜¾ç¤º
    â†“
åå°è½¬æ¢ä¸º base64 å‘é€ API
```

### CSS é€‰æ‹©å™¨æŠ€å·§

ä½¿ç”¨ä¼ªç±»é€‰æ‹©å™¨å®ç°å“åº”å¼å¸ƒå±€:
- `:first-child:last-child` - é€‰æ‹©å”¯ä¸€å­å…ƒç´ ï¼ˆ1å¼ å›¾ç‰‡ï¼‰
- `:first-child:nth-last-child(2)` - ç¬¬ä¸€ä¸ªä¸”å€’æ•°ç¬¬äºŒä¸ªï¼ˆ2å¼ ä¸­çš„ç¬¬ä¸€å¼ ï¼‰
- `:nth-child(2):last-child` - ç¬¬äºŒä¸ªä¸”æœ€åä¸€ä¸ªï¼ˆ2å¼ ä¸­çš„ç¬¬äºŒå¼ ï¼‰
- `:first-child:nth-last-child(3)` - ç¬¬ä¸€ä¸ªä¸”å€’æ•°ç¬¬ä¸‰ä¸ªï¼ˆ3å¼ ä¸­çš„ç¬¬ä¸€å¼ ï¼‰

### æ€§èƒ½ä¼˜åŒ–
- **æ‡’åŠ è½½**: å›¾ç‰‡ä½¿ç”¨å¾®ä¿¡å°ç¨‹åºåŸç”Ÿæ‡’åŠ è½½
- **å°ºå¯¸ä¼˜åŒ–**: å·²å‹ç¼©å›¾ç‰‡ï¼Œé¿å…åŠ è½½å¤§å›¾
- **ç¼“å­˜æœºåˆ¶**: å¾®ä¿¡è‡ªåŠ¨ç¼“å­˜ä¸´æ—¶æ–‡ä»¶
- **å¼‚æ­¥æ¸²æŸ“**: ä¸é˜»å¡æ¶ˆæ¯åˆ—è¡¨æ¸²æŸ“

## ğŸ§ª æµ‹è¯•è¦ç‚¹

### åŠŸèƒ½æµ‹è¯•:
- [ ] å‘é€1å¼ å›¾ç‰‡ï¼Œæ˜¾ç¤ºå¤§å›¾
- [ ] å‘é€2å¼ å›¾ç‰‡ï¼Œå¹¶æ’æ˜¾ç¤º
- [ ] å‘é€3å¼ å›¾ç‰‡ï¼Œç½‘æ ¼æ˜¾ç¤º
- [ ] å‘é€å›¾ç‰‡+æ–‡å­—ï¼Œå›¾ç‰‡åœ¨ä¸Šæ–‡å­—åœ¨ä¸‹
- [ ] ç‚¹å‡»å›¾ç‰‡è¿›å…¥é¢„è§ˆ
- [ ] åœ¨é¢„è§ˆç•Œé¢å·¦å³æ»‘åŠ¨
- [ ] é•¿æŒ‰ä¿å­˜å›¾ç‰‡
- [ ] å‘é€åå›¾ç‰‡ä»é¢„è§ˆåŒºæ¶ˆå¤±

### æ ·å¼æµ‹è¯•:
- [ ] å›¾ç‰‡åœ†è§’æ­£ç¡®æ˜¾ç¤º
- [ ] å›¾ç‰‡å°ºå¯¸ç¬¦åˆè§„èŒƒ
- [ ] å›¾ç‰‡é—´è·ç»Ÿä¸€
- [ ] ç‚¹å‡»æ—¶æœ‰è§†è§‰åé¦ˆ
- [ ] åœ¨ä¸åŒè®¾å¤‡ä¸Šæ˜¾ç¤ºæ­£å¸¸

### å…¼å®¹æ€§æµ‹è¯•:
- [ ] iOS å¾®ä¿¡å®¢æˆ·ç«¯
- [ ] Android å¾®ä¿¡å®¢æˆ·ç«¯
- [ ] å¾®ä¿¡å¼€å‘è€…å·¥å…·
- [ ] ä¸åŒå±å¹•å°ºå¯¸

## ğŸ’¡ ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### ä¼˜ç‚¹:
âœ… **ç›´è§‚å±•ç¤º**: å›¾ç‰‡ç›´æ¥æ˜¾ç¤ºåœ¨èŠå¤©çª—å£
âœ… **å¿«é€Ÿé¢„è§ˆ**: ç‚¹å‡»å³å¯æŸ¥çœ‹å¤§å›¾
âœ… **å¤šå›¾æ”¯æŒ**: æœ€å¤š3å¼ ï¼Œå¸ƒå±€åˆç†
âœ… **æµç•…åŠ¨ç”»**: ç‚¹å‡»ç¼©æ”¾æ•ˆæœè‡ªç„¶
âœ… **åŸç”Ÿä½“éªŒ**: ä½¿ç”¨å¾®ä¿¡åŸç”Ÿé¢„è§ˆåŠŸèƒ½

### æ³¨æ„äº‹é¡¹:
- å›¾ç‰‡è·¯å¾„ä¸ºæœ¬åœ°ä¸´æ—¶è·¯å¾„ï¼Œåˆ·æ–°åå¯èƒ½å¤±æ•ˆ
- ç›®å‰ä»…æ”¯æŒç”¨æˆ·æ¶ˆæ¯æ˜¾ç¤ºå›¾ç‰‡ï¼ŒAIå›å¤ä¸æ˜¾ç¤º
- å›¾ç‰‡æ•°é‡é™åˆ¶ä¸º3å¼ ï¼Œç”±ä¸Šä¼ åŠŸèƒ½æ§åˆ¶

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

1. **å†å²æ¶ˆæ¯å›¾ç‰‡æŒä¹…åŒ–**
   - ä¸Šä¼ å›¾ç‰‡åˆ°æœåŠ¡å™¨æˆ–äº‘å­˜å‚¨
   - ä¿å­˜æ°¸ä¹…URLåˆ°æ•°æ®åº“
   - åŠ è½½å†å²æ¶ˆæ¯æ—¶æ˜¾ç¤ºæ°¸ä¹…URL

2. **AIå›å¤å›¾ç‰‡æ”¯æŒ**
   - å¦‚æœAIè¿”å›å›¾ç‰‡URLï¼Œä¹Ÿèƒ½æ˜¾ç¤º
   - æ”¯æŒMarkdownå›¾ç‰‡è¯­æ³•è§£æ
   - æ˜¾ç¤ºAIç”Ÿæˆçš„å›¾è¡¨ã€å›¾ç‰‡

3. **å›¾ç‰‡åŠ è½½ä¼˜åŒ–**
   - æ·»åŠ åŠ è½½åŠ¨ç”»
   - åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºå ä½å›¾
   - æ”¯æŒé‡æ–°åŠ è½½

4. **æ›´å¤šäº¤äº’åŠŸèƒ½**
   - é•¿æŒ‰å›¾ç‰‡åˆ é™¤
   - æ‹–åŠ¨è°ƒæ•´å›¾ç‰‡é¡ºåº
   - å›¾ç‰‡ç¼–è¾‘ï¼ˆè£å‰ªã€æ»¤é•œï¼‰

5. **å¸ƒå±€ä¼˜åŒ–**
   - æ”¯æŒæ›´å¤šæ•°é‡çš„å›¾ç‰‡
   - ç€‘å¸ƒæµå¸ƒå±€
   - è‡ªé€‚åº”å›¾ç‰‡æ¯”ä¾‹

## ğŸ“ æ€»ç»“

èŠå¤©çª—å£å›¾ç‰‡æ˜¾ç¤ºåŠŸèƒ½å·²å®Œæ•´å®ç°ï¼Œæä¾›äº†ï¼š
- âœ… æ¸…æ™°çš„å›¾ç‰‡å±•ç¤º
- âœ… æµç•…çš„é¢„è§ˆä½“éªŒ
- âœ… å“åº”å¼çš„å¸ƒå±€è®¾è®¡
- âœ… åŸç”Ÿçº§çš„äº¤äº’åé¦ˆ

ç”¨æˆ·ç°åœ¨å¯ä»¥åœ¨èŠå¤©çª—å£ä¸­ç›´æ¥çœ‹åˆ°å‘é€çš„å›¾ç‰‡ï¼Œå¹¶é€šè¿‡ç‚¹å‡»è¿›å…¥å…¨å±é¢„è§ˆæ¨¡å¼ï¼Œä½“éªŒä¸è±†åŒ…ä¸€è‡´ï¼

---
**åŠŸèƒ½å®Œæˆæ—¶é—´**: 2025-12-30
**ç‰ˆæœ¬**: v2.1 (Message Images Display)
